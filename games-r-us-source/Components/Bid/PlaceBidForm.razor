@using games_r_us_source.Data;
@using games_r_us_source.Components.Helpers;
@using Microsoft.AspNetCore.Components.Authorization
@inject ApplicationDbContext dbContext;
@inject AuthenticationStateProvider AuthenticationStateProvider;
@rendermode InteractiveServer

<AuthorizeView Context="authorizeViewContext">
    <Authorized>
        <p class="font-bold text-red-600">@ErrorMessage</p>
        <p class="font-bold text-green-600">@SuccessMessage</p>
        <EditForm class="m-auto max-w-full" Model="@bid" OnValidSubmit="HandleSubmit" FormName="placeBidForm">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <label for="amount" class="block text-center">
                New bid
            </label>
            <div class="border-2 flex flex-col border-black md:flex-row">
                <InputNumber id="amount" class="w-full flex-grow" @bind-Value="@bid.Amount" />
                <button class="bg-green-500" type="submit">Place bid</button>
            </div>
        </EditForm>
    </Authorized>
    <NotAuthorized>
        <p class="font-bold">You need to be logged in to place a bid.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public Listing CurrentListing { get; set; }

    [Parameter]
    public Bid? HighestBid { get; set; }

    private string UserName { get; set; }
    private string ErrorMessage { get; set; }
    private string SuccessMessage { get; set; }

    // Create new bid object, linked to the form
    Bid bid = new Bid { Time = DateTime.Now };

    // Only runs if form contains expected data types
    private void HandleSubmit(EditContext editContext)
    {
        // The if statements below require first querying the database
        ApplicationUser user = AccountHelper.GetAccountFromUserName(UserName, dbContext);

        // If logged in user authored the listing in question
        if (CurrentListing.ApplicationUser.Id == user.Id)
        {
            ErrorMessage = "You cannot make a bid on a listing that you authored.";
            return;
        }

        // If there is a highest bid and the logged in user already holds the highest bid
        if (HighestBid is not null)
        {
            if (HighestBid.ApplicationUserID == user.Id)
            {
                ErrorMessage = "You already hold the highest bid.";
                return;
            }
        }

        if (this.bid.Amount <= 0)
        {
            ErrorMessage = "Amount cannot be less than or equal to zero.";
            return;
        }

        // If bid has no highest bid: check if bid is lower than starting price
        if (HighestBid is null)
        {
            if (this.bid.Amount <= CurrentListing.StartingPrice)
            {
                ErrorMessage = "Bid amount has to be greater than the starting price.";
                return;
            }
        }

            // If a highest bid exists, if the current bid is lower than the highest bid
        if (HighestBid is not null)
        {
            if (HighestBid.Amount >= this.bid.Amount)
            {
                ErrorMessage = "Bid amount has to trump the highest bid.";
                return;
            }
        }

        bid.ListingID = CurrentListing.ID;
        bid.Listing = CurrentListing;

        bid.ApplicationUserID = user.Id;
        bid.ApplicationUser = user;
        dbContext.Bids.Add(bid);
        dbContext.SaveChanges();

        ErrorMessage = "";
        SuccessMessage = $"Success! New bid at {bid.Amount} placed.";
    }

    protected override async Task OnInitializedAsync()
    {
        // Get the logged in user
        var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authenticationState.User;

        // Get the user's email if they are authenticated
        if (user.Identity.IsAuthenticated)
        {
            UserName = user.Identity.Name;
        }
    }
}